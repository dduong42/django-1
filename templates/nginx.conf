{% set main %}
    location {{ media_url }}  { alias {{ dir_media }}/; }
    location {{ static_url }} { alias {{ dir_static }}/; }
    location {{ sendfile_url }} {
        internal;
        root {{ dir_sendfile }};
    }
    location / {
        client_max_body_size 10m;
        include /etc/nginx/uwsgi_params;
        uwsgi_pass unix:{{ file_sock }};
    }
{% endset %}
server {
    listen 80;
    server_name {{ django_domain }};
    charset utf-8;

    error_log /var/log/nginx/{{ django_name }}_error_log;
    access_log /var/log/nginx/{{ django_name }}_access_log;

{% if django_https %}
    location /.well-known/acme-challenge {
        root {{ dir_www }};
    }
{% endif %}

    location /ping {
        include /etc/nginx/uwsgi_params;
        uwsgi_pass unix:{{ file_sock }};
    }

{% if django_http %}
    {{ main }}
{% else %}
    location / {
        return 301 https://$host$request_uri;
    }
{% endif %}
}
{% if django_https and certificate %}
server {
    listen 443;
    server_name {{ django_domain }};
    charset utf-8;

    error_log /var/log/nginx/{{ django_name }}_error_log;
    access_log /var/log/nginx/{{ django_name }}_access_log;

    ssl_certificate {{ certificate }};
    ssl_certificate_key /etc/letsencrypt/live/{{ django_domain }}/privkey.pem;

    {{ main }}
}
{% endif %}
